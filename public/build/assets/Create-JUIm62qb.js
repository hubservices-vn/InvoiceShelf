import{L as ye,e as pe,u as ve,a7 as _e,ad as fe,E as ge,F as Pe,as as be,G as $e,a4 as Be,v as he,f as $,H as Ce,W as Ie,k as I,j as Ve,am as Se,aF as we,r as u,o as V,c as Me,a as o,w as l,b as B,l as t,m as q,J as z,K as U,p as S,t as v,q as qe,N as ke,g as h,h as k,aO as Ne,af as Ue,V as De}from"./main-CO79g86p.js";import{_ as Fe}from"./ExchangeRateConverter-D1vw6CF1.js";import{u as Ae}from"./payment-USkgOKPm.js";import{_ as Ee}from"./SelectNotePopup-CaNg6Hl7.js";import{_ as Ge}from"./CreateCustomFields-BwgoYUp8.js";import{_ as Le}from"./PaymentModeModal-DNzyQEJp.js";import{_ as je}from"./CategoryModal-B6qjjN57.js";import{u as Te}from"./category-R7YScaiA.js";import"./exchange-rate-CVxb6dGe.js";import"./NoteModal-CEsnLFCR.js";import"./dynamic-import-helper-BheWnx7M.js";const xe={class:"absolute left-3.5"},ze={class:"relative w-full"},He={class:"relative mt-6"},Re={class:"z-20 float-right text-sm font-semibold leading-5 text-primary-400"},Je={class:"mb-4 text-sm font-medium text-gray-800"},H="newEstimate",rt={__name:"Create",setup(Ke){const R=Te(),c=ye(),J=pe(),e=Ae();ve();const w=_e();fe(),ge();const D=Pe(),F=be();$e();const A=Be("utils"),{t:y}=he.useI18n();let P=$(!1),M=$(!1),_=$([]);const f=$(null),K=Ce(["customer","company","customerCustom","payment","paymentCustom"]);function O(){D.openModal({title:y("settings.category.add_category"),componentName:"CategoryModal",size:"sm",refreshData:G,data:{type:"payment"}})}const E=$([]),N=$(!1);async function G(a=void 0){var m;N.value=!0;const n=await R.fetchCategories({search:a,type:"payment",limit:"all"});n.data.data.length&&(E.value=((m=n.data)==null?void 0:m.data)||[]),N.value=!1}Ie(()=>{G()});const C=I({get:()=>e.currentPayment.amount/100,set:a=>{e.currentPayment.amount=Math.round(a*100)}}),s=I(()=>e.isFetchingInitialData),d=I(()=>c.name==="payments.edit"),L=I(()=>d.value?y("payments.edit_payment"):y("payments.new_payment")),W=I(()=>({currentPayment:{customer_id:{required:h.withMessage(y("validation.required"),k)},payment_date:{required:h.withMessage(y("validation.required"),k)},amount:{required:h.withMessage(y("validation.required"),k),between:h.withMessage(y("validation.payment_greater_than_due_amount"),Ne(0,e.currentPayment.maxPayableAmount))},exchange_rate:{required:Ue(function(){return h.withMessage(y("validation.required"),k),e.showExchangeRate}),decimal:h.withMessage(y("validation.valid_exchange_rate"),De)}}})),i=Ve(W,e,{$scope:H});Se(()=>{e.currentPayment.customer_id&&ee(e.currentPayment.customer_id),c.query.customer&&(e.currentPayment.customer_id=c.query.customer)}),e.resetCurrentPayment(),c.query.customer&&(e.currentPayment.customer_id=c.query.customer),e.fetchPaymentInitialData(d.value),c.params.id&&!d.value&&Y();async function Q(){D.openModal({title:y("settings.payment_modes.add_payment_mode"),componentName:"PaymentModeModal"})}function X(a){e.currentPayment.notes=""+a.notes}async function Y(){var n;let a=await F.fetchInvoice((n=c==null?void 0:c.params)==null?void 0:n.id);e.currentPayment.customer_id=a.data.data.customer.id,e.currentPayment.invoice_id=a.data.data.id}async function Z(a){a&&(f.value=_.value.find(n=>n.id===a),C.value=f.value.due_amount/100,e.currentPayment.maxPayableAmount=f.value.due_amount)}function ee(a){if(a){let n={customer_id:a,status:"DUE",limit:"all"};d.value&&(n.status=""),M.value=!0,Promise.all([F.fetchInvoices(n),w.fetchCustomer(a)]).then(async([m,g])=>{m&&(_.value=[...m.data.data]),g&&g.data&&(e.currentPayment.selectedCustomer=g.data.data,e.currentPayment.customer=g.data.data,e.currentPayment.currency=g.data.data.currency,d.value&&!w.editCustomer&&e.currentPayment.customer_id&&(w.editCustomer=g.data.data)),e.currentPayment.invoice_id&&(f.value=_.value.find(p=>p.id===e.currentPayment.invoice_id),e.currentPayment.maxPayableAmount=f.value.due_amount+e.currentPayment.amount,C.value===0&&(C.value=f.value.due_amount/100)),d.value&&(_.value=_.value.filter(p=>p.due_amount>0||p.id==e.currentPayment.invoice_id)),M.value=!1}).catch(m=>{M.value=!1,console.error(m,"error")})}}we(()=>{e.resetCurrentPayment(),_.value=[],w.editCustomer=null});async function te(){if(i.value.$touch(),i.value.$invalid)return!1;P.value=!0;let a={...e.currentPayment},n=null;try{n=await(d.value?e.updatePayment:e.addPayment)(a),J.push(`/admin/payments/${n.data.data.id}/view`)}catch{P.value=!1}}function ae(a){let n={userId:a};c.params.id&&(n.model_id=c.params.id),e.currentPayment.invoice_id=f.value=null,e.currentPayment.amount=0,_.value=[],e.getNextNumber(n,!0)}return(a,n)=>{const m=u("BaseBreadcrumbItem"),g=u("BaseBreadcrumb"),p=u("BaseIcon"),j=u("BaseButton"),ne=u("BasePageHeader"),oe=u("BaseDatePicker"),b=u("BaseInputGroup"),re=u("BaseInput"),T=u("BaseSelectAction"),le=u("BaseTreeSelect"),se=u("BaseCustomerSelectInput"),x=u("BaseMultiselect"),ue=u("BaseMoney"),ie=u("BaseInputGrid"),me=u("BaseCustomInput"),ce=u("BaseCard"),de=u("BasePage");return V(),Me(ke,null,[o(Le),o(je),o(de,{class:"relative payment-create"},{default:l(()=>[B("form",{action:"",onSubmit:qe(te,["prevent"])},[o(ne,{title:L.value,class:"mb-5"},{actions:l(()=>[o(j,{loading:t(P),disabled:t(P),variant:"primary",type:"submit",class:"hidden sm:flex"},{left:l(r=>[t(P)?U("",!0):(V(),q(p,{key:0,name:"SaveIcon",class:z(r.class)},null,8,["class"]))]),default:l(()=>[S(" "+v(d.value?a.$t("payments.update_payment"):a.$t("payments.save_payment")),1)]),_:1},8,["loading","disabled"])]),default:l(()=>[o(g,null,{default:l(()=>[o(m,{title:a.$t("general.home"),to:"/admin/dashboard"},null,8,["title"]),o(m,{title:a.$t("payments.payment",2),to:"/admin/payments"},null,8,["title"]),o(m,{title:L.value,to:"#",active:""},null,8,["title"])]),_:1})]),_:1},8,["title"]),o(ce,null,{default:l(()=>[o(ie,null,{default:l(()=>[o(b,{label:a.$t("payments.date"),"content-loading":s.value,required:"",error:t(i).currentPayment.payment_date.$error&&t(i).currentPayment.payment_date.$errors[0].$message},{default:l(()=>[o(oe,{modelValue:t(e).currentPayment.payment_date,"onUpdate:modelValue":[n[0]||(n[0]=r=>t(e).currentPayment.payment_date=r),n[1]||(n[1]=r=>t(i).currentPayment.payment_date.$touch())],"content-loading":s.value,"calendar-button":!0,"calendar-button-icon":"calendar",invalid:t(i).currentPayment.payment_date.$error},null,8,["modelValue","content-loading","invalid"])]),_:1},8,["label","content-loading","error"]),o(b,{label:a.$t("payments.payment_number"),"content-loading":s.value,required:""},{default:l(()=>[o(re,{modelValue:t(e).currentPayment.payment_number,"onUpdate:modelValue":n[2]||(n[2]=r=>t(e).currentPayment.payment_number=r),"content-loading":s.value},null,8,["modelValue","content-loading"])]),_:1},8,["label","content-loading"]),o(b,{label:a.$t("categories.label"),"content-loading":a.isFetchingInitialData},{default:l(()=>[o(le,{name:"parent_id","value-prop":"id","label-prop":"name",placeholder:a.$t("categories.select_a_category"),"parent-prop":"parent_id",options:E.value,"content-loading":s.value,loading:N.value,modelValue:t(e).currentPayment.category_id,"onUpdate:modelValue":n[3]||(n[3]=r=>t(e).currentPayment.category_id=r)},{"after-list":l(()=>[o(T,{onClick:O},{default:l(()=>[o(p,{name:"PlusIcon",class:"h-4 mr-2 -ml-2 text-center text-primary-400"}),S(" "+v(a.$t("settings.category.add_new_category")),1)]),_:1})]),_:1},8,["placeholder","options","content-loading","loading","modelValue"])]),_:1},8,["label","content-loading"]),o(b,{label:a.$t("payments.customer"),error:t(i).currentPayment.customer_id.$error&&t(i).currentPayment.customer_id.$errors[0].$message,"content-loading":s.value,required:""},{default:l(()=>[s.value?U("",!0):(V(),q(se,{key:0,modelValue:t(e).currentPayment.customer_id,"onUpdate:modelValue":[n[4]||(n[4]=r=>t(e).currentPayment.customer_id=r),n[5]||(n[5]=r=>ae(t(e).currentPayment.customer_id))],"content-loading":s.value,invalid:t(i).currentPayment.customer_id.$error,placeholder:a.$t("customers.select_a_customer"),"show-action":""},null,8,["modelValue","content-loading","invalid","placeholder"]))]),_:1},8,["label","error","content-loading"]),o(b,{"content-loading":s.value,label:a.$t("payments.invoice"),"help-text":f.value?`Due Amount: ${t(e).currentPayment.maxPayableAmount/100}`:""},{default:l(()=>[o(x,{modelValue:t(e).currentPayment.invoice_id,"onUpdate:modelValue":n[6]||(n[6]=r=>t(e).currentPayment.invoice_id=r),"content-loading":s.value,"value-prop":"id","track-by":"invoice_number",label:"invoice_number",options:t(_),loading:t(M),placeholder:a.$t("invoices.select_invoice"),onSelect:Z},{singlelabel:l(({value:r})=>[B("div",xe,v(r.invoice_number)+" ("+v(t(A).formatMoney(r.total,r.customer.currency))+") ",1)]),option:l(({option:r})=>[S(v(r.invoice_number)+" ("+v(t(A).formatMoney(r.total,r.customer.currency))+") ",1)]),_:1},8,["modelValue","content-loading","options","loading","placeholder"])]),_:1},8,["content-loading","label","help-text"]),o(b,{label:a.$t("payments.amount"),"content-loading":s.value,error:t(i).currentPayment.amount.$error&&t(i).currentPayment.amount.$errors[0].$message,required:""},{default:l(()=>[B("div",ze,[(V(),q(ue,{key:t(e).currentPayment.currency,modelValue:C.value,"onUpdate:modelValue":[n[7]||(n[7]=r=>C.value=r),n[8]||(n[8]=r=>t(i).currentPayment.amount.$touch())],currency:t(e).currentPayment.currency,"content-loading":s.value,invalid:t(i).currentPayment.amount.$error},null,8,["modelValue","currency","content-loading","invalid"]))])]),_:1},8,["label","content-loading","error"]),o(b,{"content-loading":s.value,label:a.$t("payments.payment_mode")},{default:l(()=>[o(x,{modelValue:t(e).currentPayment.payment_method_id,"onUpdate:modelValue":n[9]||(n[9]=r=>t(e).currentPayment.payment_method_id=r),"content-loading":s.value,label:"name","value-prop":"id","track-by":"name",options:t(e).paymentModes,placeholder:a.$t("payments.select_payment_mode"),searchable:""},{action:l(()=>[o(T,{onClick:Q},{default:l(()=>[o(p,{name:"PlusIcon",class:"h-4 mr-2 -ml-2 text-center text-primary-400"}),S(" "+v(a.$t("settings.payment_modes.add_payment_mode")),1)]),_:1})]),_:1},8,["modelValue","content-loading","options","placeholder"])]),_:1},8,["content-loading","label"]),o(Fe,{store:t(e),"store-prop":"currentPayment",v:t(i).currentPayment,"is-loading":s.value,"is-edit":d.value,"customer-currency":t(e).currentPayment.currency_id},null,8,["store","v","is-loading","is-edit","customer-currency"])]),_:1}),o(Ge,{type:"Payment","is-edit":d.value,"is-loading":s.value,store:t(e),"store-prop":"currentPayment","custom-field-scope":H,class:"mt-6"},null,8,["is-edit","is-loading","store"]),B("div",He,[B("div",Re,[o(Ee,{type:"Payment",onSelect:X})]),B("label",Je,v(a.$t("estimates.notes")),1),o(me,{modelValue:t(e).currentPayment.notes,"onUpdate:modelValue":n[10]||(n[10]=r=>t(e).currentPayment.notes=r),"content-loading":s.value,fields:K,class:"mt-1"},null,8,["modelValue","content-loading","fields"])]),o(j,{loading:t(P),"content-loading":s.value,variant:"primary",type:"submit",class:"flex justify-center w-full mt-4 sm:hidden md:hidden"},{left:l(r=>[t(P)?U("",!0):(V(),q(p,{key:0,name:"SaveIcon",class:z(r.class)},null,8,["class"]))]),default:l(()=>[S(" "+v(d.value?a.$t("payments.update_payment"):a.$t("payments.save_payment")),1)]),_:1},8,["loading","content-loading"])]),_:1})],32)]),_:1})],64)}}};export{rt as default};
